


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    
  <title>Tim Robinson</title>
<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
<link rel="alternate" type="application/atom+xml" title="Atom 1.0"
href="/blog/feed/atom" />

<link rel='stylesheet' href='/css/pygments_murphy.css' type='text/css' />
<link rel='stylesheet' href='/css/pygments_monokai.css' type='text/css' />
<link rel='stylesheet' href='/css/site.css' type='text/css' />
<link rel='stylesheet' href='/css/documentation.css' type='text/css' />
<link rel='stylesheet' href='/css/jquery.tweet.css' type='text/css' />

<script type="text/javascript" src="/js/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="/js/jquery.tweet.js"></script>
<script type="text/javascript" src="/js/googleRSSWidget.js"></script>
<script type="text/javascript" src="/js/site.js"></script>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-8369986-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


  </head>
  <body>
    <div id="content">
      
  
<div id="top_bar">
  <div class="ButtonBar">
      <div id="plugbanner"></div>
      <div id="blog_logo"></div>
      <h1><a href="/blog/">
          <span id="blog_name">
            Tim Robinson
          </span>
        </a>
      </h1>
  </div>
  <div id="search">    
    <form id="searchform" method="get" action="http://www.google.com/search">
      <input type="hidden" name="ie" value="UTF-8">
      <input type="hidden" name="oe" value="UTF-8">
      <input type="hidden" name="domains" value="www.partario.com">
      <input type="hidden" name="sitesearch" value="www.partario.com">
      <input name="q" id="q" size="20" value="search in blog..." onfocus="if(this.value==this.defaultValue) this.value='';" type="text">
    </form>
  </div>
</div>


      <div id="main_block">
        <div id="prose_block">
          
  



<div class="blog_post" id="lisp-compiler-in-f#:-expression-trees-and-.net-methods">
  <a class="blog_post_title" name="Lisp compiler in F#: Expression trees and .NET methods" />
  <h2 class="blog_post_title"><a href="/blog/2009/06/lisp-compiler-in-f-expression-trees-and-net-methods.html" rel="bookmark" title="Permanent Link to Lisp compiler in F#: Expression trees and .NET methods">Lisp compiler in F#: Expression trees and .NET methods</a></h2>
  <small>June 01, 2009 at 10:36 PM | categories: 

<a href='/blog/category/compiler'>Compiler</a>
 | <a href="http://www.partario.com/blog/2009/06/lisp-compiler-in-f-expression-trees-and-net-methods.html#disqus_thread">View Comments</a>
  </small>
  <span class="post_prose">
    
  
<p id="p1">This is part 3 of a series of posts on my Lisp compiler written in F#. Previous entries: <a href="/blog/2009/05/lisp-compiler-in-f-introduction.html">Introduction</a>, <a href="/blog/2009/05/lisp-compiler-in-f-parsing-with-fslex-and-fsyacc.html">Parsing with fslex and fsyacc</a> | <a href="http://github.com/timrobinson/fsharp-lisp/tree/master">Browse the full source of the compiler on GitHub</a></p>
<p id="p2">Thanks to <em>fslex</em>, <em>fsyacc</em> and the <code>LispVal</code> type, we've ended up with an expression tree that represents our program. To summarise, we've turned this:</p>

<div class="pygments_murphy"><pre>(define (fact n) (if (= n 0) 1 (* n (fact (- n 1)))))
(Console.WriteLine "6! = {0}" (fact 6))
(Console.WriteLine "What is your name?")
(Console.WriteLine "Hello, {0}" (Console.ReadLine))
</pre></div>



<p id="p3">...into an F# data structure that looks like this:</p>

<div class="pygments_murphy"><pre><span class="o">[</span><span class="nc">List</span>
   <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"define"</span><span class="o">;</span> <span class="nc">List</span> <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"fact"</span><span class="o">;</span> <span class="nc">Atom</span> <span class="s2">"n"</span><span class="o">];</span>
    <span class="nc">List</span>
      <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"if"</span><span class="o">;</span> <span class="nc">List</span> <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"="</span><span class="o">;</span> <span class="nc">Atom</span> <span class="s2">"n"</span><span class="o">;</span> <span class="nc">Number</span> <span class="mi">0</span><span class="o">];</span> <span class="nc">Number</span> <span class="mi">1</span><span class="o">;</span>
       <span class="nc">List</span>
         <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"*"</span><span class="o">;</span> <span class="nc">Atom</span> <span class="s2">"n"</span><span class="o">;</span>
          <span class="nc">List</span> <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"fact"</span><span class="o">;</span> <span class="nc">List</span> <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"-"</span><span class="o">;</span> <span class="nc">Atom</span> <span class="s2">"n"</span><span class="o">;</span> <span class="nc">Number</span> <span class="mi">1</span><span class="o">]]]]];</span>
 <span class="nc">List</span>
   <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"Console.WriteLine"</span><span class="o">;</span> <span class="nc">String</span> <span class="s2">"6! = {0}"</span><span class="o">;</span> <span class="nc">List</span> <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"fact"</span><span class="o">;</span> <span class="nc">Number</span> <span class="mi">6</span><span class="o">]];</span>
 <span class="nc">List</span> <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"Console.WriteLine"</span><span class="o">;</span> <span class="nc">String</span> <span class="s2">"What is your name?"</span><span class="o">];</span>
 <span class="nc">List</span>
   <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"Console.WriteLine"</span><span class="o">;</span> <span class="nc">String</span> <span class="s2">"Hello, {0}"</span><span class="o">;</span>
    <span class="nc">List</span> <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"Console.ReadLine"</span><span class="o">]]]</span>
</pre></div>



<p id="p4">We'd like to turn this data structure into actual IL, which we can execute. I'll assume some restrictions:</p>
<ul>
  <li>We're going to compile, not interpret, and we're going to target .NET IL, not x86 machine code, <a href="http://llvm.org/">LLVM</a>, or anything else at this point</li>

  <li>Basic arithmetic (+, -, *, /) on integers<br/>
  <code>(- n 1)</code></li>

  <li>Equality comparisons<br/>
  <code>(= n 0)</code></li>

  <li><code>if</code> statements<br/>
  <code>(if (= n 0) a b)</code></li>

  <li>Call static .NET methods (no <code>new</code> operator and no instance methods)<br/>
  <code>(Console.WriteLine "What is your name?")</code></li>

  <li>Define and call our own functions<br/>
  <code>(define (fact n) (if (= n 0) 1 (* n (fact (- n 1)))))</code></li>
</ul>
<p id="p5">What we'll do is:</p>
<ol>
  <li>Preprocess built-in forms such as arithmetic, <code>define</code>, <code>if</code> and <code>lambda</code> into specific nodes in the expression tree</li>

  <li>Construct an instance of <code>System.Reflection.Emit.ILGenerator</code>. We could write an EXE or DLL file, but for experimentation, it's handy to target a <code>DynamicMethod</code></li>

  <li>Emit IL opcodes that implement the expression tree</li>
</ol>
<p id="p6">First, a couple of pattern matching functions to recognise the built-in forms. Strictly speaking, we could write a code generator which recognises the built-in forms directly, but turning them into first-class expression tree nodes early on will hopefully make it easier to apply compiler optimisations, which I hope to add at some point.</p>
<p class="alt" id="p7"><a href="http://github.com/timrobinson/fsharp-lisp/blob/b13a8c59066040b7c007b0a4bea28a7fc2163fc1/Core/CodeGenerator.fs">CodeGenerator.fs</a></p>

<div class="pygments_murphy"><pre><span class="o">//</span> <span class="nc">Turn</span> <span class="n">a</span> <span class="nc">LispVal</span> <span class="n">into</span> <span class="n">a</span> <span class="k">function</span> <span class="ow">or</span> <span class="n">variable</span> <span class="n">name</span>
<span class="k">let</span> <span class="n">extractAtom</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="nc">Atom</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span>
    <span class="o">|</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="o">&lt;|</span> <span class="nc">Compiler</span><span class="o">(</span><span class="n">sprintf</span> <span class="s2">"expected atom, got %A"</span> <span class="n">v</span><span class="o">)</span>

<span class="o">//</span> <span class="nc">Note</span><span class="o">:</span> <span class="n">insertPrimitives</span> <span class="n">accepts</span> <span class="n">a</span> <span class="nc">LispVal</span> <span class="ow">and</span> <span class="n">returns</span> <span class="n">a</span> <span class="nn">LispVal</span><span class="p">.</span>
<span class="err">//</span> <span class="nc">The</span> <span class="k">function</span> <span class="n">keyword</span> <span class="n">combines</span> <span class="k">function</span> <span class="n">declaration</span> <span class="k">with</span> <span class="n">pattern</span> <span class="n">matching</span><span class="o">.</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">insertPrimitives</span> <span class="o">=</span> 
    <span class="k">function</span>
    <span class="o">//</span> <span class="nc">Convert</span> <span class="n">arithmetic</span> <span class="n">operators</span> <span class="n">into</span> <span class="nc">ListPrimitive</span>
    <span class="o">|</span> <span class="nc">List</span> <span class="o">(</span><span class="nc">Atom</span> <span class="s2">"+"</span> <span class="o">::</span> <span class="n">args</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">ListPrimitive</span> <span class="o">(</span><span class="nc">Add</span><span class="o">,</span> <span class="n">args</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">insertPrimitives</span><span class="o">)</span>
    <span class="o">|</span> <span class="nc">List</span> <span class="o">(</span><span class="nc">Atom</span> <span class="s2">"-"</span> <span class="o">::</span> <span class="n">args</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">ListPrimitive</span> <span class="o">(</span><span class="nc">Subtract</span><span class="o">,</span> <span class="n">args</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">insertPrimitives</span><span class="o">)</span>
    <span class="o">|</span> <span class="nc">List</span> <span class="o">(</span><span class="nc">Atom</span> <span class="s2">"*"</span> <span class="o">::</span> <span class="n">args</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">ListPrimitive</span> <span class="o">(</span><span class="nc">Multiply</span><span class="o">,</span> <span class="n">args</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">insertPrimitives</span><span class="o">)</span>
    <span class="o">|</span> <span class="nc">List</span> <span class="o">(</span><span class="nc">Atom</span> <span class="s2">"/"</span> <span class="o">::</span> <span class="n">args</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">ListPrimitive</span> <span class="o">(</span><span class="nc">Divide</span><span class="o">,</span> <span class="n">args</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">insertPrimitives</span><span class="o">)</span>
    <span class="o">|</span> <span class="nc">List</span> <span class="o">(</span><span class="nc">Atom</span> <span class="s2">"="</span> <span class="o">::</span> <span class="n">args</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">ListPrimitive</span> <span class="o">(</span><span class="nc">Equal</span><span class="o">,</span> <span class="n">args</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">insertPrimitives</span><span class="o">)</span>

    <span class="o">|</span> <span class="nc">List</span> <span class="o">(</span><span class="nc">Atom</span> <span class="s2">"define"</span> <span class="o">::</span> <span class="n">args</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">args</span> <span class="k">with</span>
        <span class="o">|</span> <span class="o">[</span> <span class="nc">Atom</span> <span class="n">name</span><span class="o">;</span> <span class="n">v</span> <span class="o">]</span> <span class="o">-&gt;</span> 
            <span class="o">//</span> <span class="nc">Convert</span> <span class="o">(</span><span class="n">define</span> <span class="n">variableName</span> <span class="n">value</span><span class="o">)</span> <span class="n">into</span> <span class="nc">VariableDef</span>
            <span class="nc">VariableDef</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">insertPrimitives</span> <span class="n">v</span><span class="o">)</span>

        <span class="o">|</span> <span class="o">[</span> <span class="nc">List</span> <span class="o">(</span><span class="nc">Atom</span> <span class="n">name</span> <span class="o">::</span> <span class="n">names</span><span class="o">);</span> <span class="n">body</span> <span class="o">]</span> <span class="o">-&gt;</span> 
            <span class="o">//</span> <span class="nc">Convert</span> <span class="o">(</span><span class="n">define</span> <span class="n">functionName</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="n">z</span><span class="o">)</span> <span class="n">value</span><span class="o">)</span> <span class="n">into</span> <span class="n">a</span> <span class="nc">VariableDef</span> <span class="n">wrapping</span> <span class="n">a</span> <span class="nc">LambdaDef</span>
            <span class="o">//</span> <span class="nc">This</span> <span class="n">represents</span> <span class="n">a</span> <span class="n">named</span> <span class="n">static</span> <span class="o">.</span><span class="nc">NET</span> <span class="k">method</span>
            <span class="nc">VariableDef</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="nc">LambdaDef</span> <span class="o">(</span><span class="n">names</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">extractAtom</span><span class="o">,</span> <span class="n">insertPrimitives</span> <span class="n">body</span><span class="o">))</span>

        <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> 
            <span class="o">//</span> <span class="nc">Note</span><span class="o">:</span> <span class="s2">"raise &lt;| Compiler message"</span> <span class="n">is</span> <span class="n">equivalent</span> <span class="k">to</span> <span class="nc">C</span><span class="o">#</span> <span class="s2">"throw new CompilerException(message)"</span>
            <span class="k">raise</span> <span class="o">&lt;|</span> <span class="nc">Compiler</span> <span class="s2">"expected define name value"</span>

    <span class="o">|</span> <span class="nc">List</span> <span class="o">(</span><span class="nc">Atom</span> <span class="s2">"if"</span> <span class="o">::</span> <span class="n">args</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">args</span> <span class="k">with</span>
        <span class="o">|</span> <span class="o">[</span> <span class="n">testValue</span><span class="o">;</span> <span class="n">thenValue</span><span class="o">;</span> <span class="n">elseValue</span> <span class="o">]</span> <span class="o">-&gt;</span> 
            <span class="o">//</span> <span class="nc">Convert</span> <span class="o">(</span><span class="k">if</span> <span class="n">test</span> <span class="k">then</span> <span class="k">else</span><span class="o">)</span> <span class="n">into</span> <span class="nc">IfPrimitive</span><span class="o">)</span>
            <span class="nc">IfPrimitive</span> <span class="o">(</span><span class="n">insertPrimitives</span> <span class="n">testValue</span><span class="o">,</span> <span class="n">insertPrimitives</span> <span class="n">thenValue</span><span class="o">,</span> <span class="n">insertPrimitives</span> <span class="n">elseValue</span><span class="o">)</span>

        <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> 
            <span class="k">raise</span> <span class="o">&lt;|</span> <span class="nc">Compiler</span> <span class="s2">"expected three items for if"</span>

    <span class="o">|</span> <span class="nc">List</span> <span class="o">(</span><span class="nc">Atom</span> <span class="s2">"lambda"</span> <span class="o">::</span> <span class="n">args</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">args</span> <span class="k">with</span>
        <span class="o">|</span> <span class="o">[</span> <span class="nc">List</span> <span class="n">names</span><span class="o">;</span> <span class="n">body</span> <span class="o">]</span> <span class="o">-&gt;</span> 
            <span class="o">//</span> <span class="nc">Convert</span> <span class="o">(</span><span class="n">lambda</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="n">z</span><span class="o">)</span> <span class="n">value</span><span class="o">)</span> <span class="n">into</span> <span class="nc">LambdaDef</span><span class="o">,</span> <span class="n">without</span> <span class="n">a</span> <span class="nc">VariableDef</span>
            <span class="nc">LambdaDef</span> <span class="o">(</span><span class="n">names</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">extractAtom</span><span class="o">,</span> <span class="n">insertPrimitives</span> <span class="n">body</span><span class="o">)</span>

        <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> 
            <span class="k">raise</span> <span class="o">&lt;|</span> <span class="nc">Compiler</span> <span class="s2">"expected lambda names body"</span>

    <span class="o">|</span> <span class="nc">List</span> <span class="n">l</span> <span class="o">-&gt;</span> 
        <span class="o">//</span> <span class="nc">Apply</span> <span class="n">insertPrimitives</span> <span class="n">recursively</span> <span class="n">on</span> <span class="n">any</span> <span class="k">function</span> <span class="n">invokations</span>
        <span class="n">l</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">insertPrimitives</span> <span class="o">|&gt;</span> <span class="nc">List</span>

    <span class="o">|</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">v</span>
</pre></div>



<p id="p8">The <code>insertPrimitives</code> function turns our parsed expression tree into this:</p>

<div class="pygments_murphy"><pre><span class="o">[</span><span class="nc">VariableDef</span>
   <span class="o">(</span><span class="s2">"fact"</span><span class="o">,</span>
    <span class="nc">LambdaDef</span>
      <span class="o">([</span><span class="s2">"n"</span><span class="o">],</span>
       <span class="nc">IfPrimitive</span>
         <span class="o">(</span><span class="nc">ListPrimitive</span> <span class="o">(</span><span class="nc">Equal</span><span class="o">,[</span><span class="nc">Atom</span> <span class="s2">"n"</span><span class="o">;</span> <span class="nc">Number</span> <span class="mi">0</span><span class="o">]),</span><span class="nc">Number</span> <span class="mi">1</span><span class="o">,</span>
          <span class="nc">ListPrimitive</span>
            <span class="o">(</span><span class="nc">Multiply</span><span class="o">,</span>
             <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"n"</span><span class="o">;</span>
              <span class="nc">List</span> <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"fact"</span><span class="o">;</span> <span class="nc">ListPrimitive</span> <span class="o">(</span><span class="nc">Subtract</span><span class="o">,[</span><span class="nc">Atom</span> <span class="s2">"n"</span><span class="o">;</span> <span class="nc">Number</span> <span class="mi">1</span><span class="o">])]]))));</span>
 <span class="nc">List</span>
   <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"Console.WriteLine"</span><span class="o">;</span> <span class="nc">String</span> <span class="s2">"6! = {0}"</span><span class="o">;</span> <span class="nc">List</span> <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"fact"</span><span class="o">;</span> <span class="nc">Number</span> <span class="mi">6</span><span class="o">]];</span>
 <span class="nc">List</span> <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"Console.WriteLine"</span><span class="o">;</span> <span class="nc">String</span> <span class="s2">"What is your name?"</span><span class="o">];</span>
 <span class="nc">List</span>
   <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"Console.WriteLine"</span><span class="o">;</span> <span class="nc">String</span> <span class="s2">"Hello, {0}"</span><span class="o">;</span>
    <span class="nc">List</span> <span class="o">[</span><span class="nc">Atom</span> <span class="s2">"Console.ReadLine"</span><span class="o">]]]</span>
</pre></div>



<p id="p9">We're going to write an F# function that emits IL for one line in our program, and looks like this:</p>

<div class="pygments_murphy"><pre><span class="k">let</span> <span class="k">rec</span> <span class="n">compile</span>
    <span class="o">(</span><span class="n">generator</span> <span class="o">:</span> <span class="nc">ILGenerator</span><span class="o">)</span>
    <span class="o">(</span><span class="n">defineMethod</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="nc">Type</span> <span class="o">-&gt;</span> <span class="nc">Type</span> <span class="kt">list</span> <span class="o">-&gt;</span> <span class="o">#</span><span class="nc">MethodInfo</span> <span class="o">*</span> <span class="nc">ILGenerator</span><span class="o">)</span>
    <span class="o">(</span><span class="n">env</span> <span class="o">:</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="nc">LispVal</span><span class="o">&gt;)</span>
    <span class="o">(</span><span class="n">value</span> <span class="o">:</span> <span class="nc">LispVal</span><span class="o">)</span> 
    <span class="o">:</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="nc">LispVal</span><span class="o">&gt;)</span>
</pre></div>



<p id="p10">What this function signature tells us is:</p>
<ul>
  <li>We have a recursive function called <code>compile</code> (by default, F# functions aren't allowed to call themselves, hence the <code>rec</code> keyword)</li>

  <li>It takes the following parameters:

    <ol>
      <li>An <code>ILGenerator</code>, i.e. the target of the IL we're going to generate</li>

      <li>A function that accepts a <code>string</code>, a <code>Type</code>, a <code>list</code> of <code>Type</code>, and returns a tuple containing a <code>MethodInfo</code> (or a type derived from <code>MethodInfo</code>, hence the #) and another <code>ILGenerator</code>. This will be the callback that <code>compile</code> will call to create a new static method for <code>lambda</code>: the <code>string</code> is a function name, the <code>Type</code> is a return type, and the <code>Type list</code> is a list of parameter types.</li>

      <li>A <code>Map</code> of <code>string</code> to <code>LispVal</code>, i.e. the variables and functions defined by prior statements in the program</li>

      <li>A <code>LispVal</code> representing the statement to generate code for</li>
    </ol>
  </li>

  <li>It returns <code>Map&lt;string, LispVal&gt;</code>, i.e. a copy of <code>env</code>, possibly with some new variables or functions added</li>
</ul>
<p id="p11">I'll cover the details of the <code>compile</code> function itself in the next post. In this one I'd like to explain a couple of helper functions:</p>
<ul>
  <li><code>typeOf</code>, which returns the .NET <code>Type</code> denoted by a <code>LispVal</code></li>

  <li><code>lambdaIdent</code>, which retrieves a <code>LambdaDef</code></li>
</ul>
<p id="p12">We're using <code>LambdaDef</code> nodes not only to define our own functions (like <code>fact</code> in our example above, which calculates factorials), but also any .NET methods we call. <code>typeOf</code> and <code>lambdaIdent</code> call each other, so we have to define them together with F#'s <code>and</code> keyword in between them:</p>
<ul>
  <li><code>typeOf</code> needs to call <code>lambdaIdent</code> in order to determine the type returned by a function invocation</li>

  <li><code>lambdaIdent</code> needs to call <code>typeOf</code> when it looks at the types of function arguments when deciding which overload of a .NET method to call</li>
</ul>

<div class="pygments_murphy"><pre><span class="k">let</span> <span class="k">rec</span> <span class="n">typeOf</span> <span class="o">(</span><span class="n">env</span> <span class="o">:</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="nc">LispVal</span><span class="o">&gt;)</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="nc">ArgRef</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="nc">Atom</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">ident</span> <span class="n">env</span> <span class="o">|&gt;</span> <span class="n">typeOf</span> <span class="n">env</span>
    <span class="o">|</span> <span class="nc">Bool</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="nc">IfPrimitive</span> <span class="o">(_,</span> <span class="n">thenValue</span><span class="o">,</span> <span class="n">elseValue</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">typeOf</span> <span class="n">env</span> <span class="n">thenValue</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">t</span> <span class="k">when</span> <span class="n">t</span> <span class="o">=</span> <span class="n">typeOf</span> <span class="n">env</span> <span class="n">elseValue</span> <span class="o">-&gt;</span> <span class="n">t</span>
        <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="o">&lt;|</span> <span class="nc">Compiler</span><span class="o">(</span><span class="s2">"expected 'then' and 'else' branches to have same type"</span><span class="o">)</span>

    <span class="o">|</span> <span class="nc">LambdaDef</span> <span class="o">(_,</span> <span class="n">body</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">typeOf</span> <span class="n">env</span> <span class="n">body</span>
    <span class="o">|</span> <span class="nc">LambdaRef</span> <span class="o">(</span><span class="n">methodBuilder</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="n">methodBuilder</span><span class="o">.</span><span class="nc">ReturnType</span>
    <span class="o">|</span> <span class="nc">List</span> <span class="o">(</span><span class="nc">Atom</span> <span class="n">a</span> <span class="o">::</span> <span class="n">args</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">lambdaIdent</span> <span class="n">args</span> <span class="n">env</span> <span class="o">|&gt;</span> <span class="n">typeOf</span> <span class="n">env</span>
    <span class="o">|</span> <span class="nc">List</span> <span class="o">(</span><span class="n">fn</span> <span class="o">::</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="o">&lt;|</span> <span class="nc">Compiler</span><span class="o">(</span><span class="n">sprintf</span> <span class="s2">"can't invoke %A"</span> <span class="n">fn</span><span class="o">)</span>
    <span class="o">|</span> <span class="nc">List</span> <span class="o">[</span> <span class="o">]</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="o">&lt;|</span> <span class="nc">Compiler</span><span class="o">(</span><span class="s2">"can't compile empty list"</span><span class="o">)</span>
    <span class="o">|</span> <span class="nc">ListPrimitive</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="nc">Number</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="nc">String</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="nc">VariableDef</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="nc">VariableRef</span> <span class="n">local</span> <span class="o">-&gt;</span> <span class="n">local</span><span class="o">.</span><span class="nc">LocalType</span>  
</pre></div>



<p id="p13"><code>lambdaIdent</code> is moderately complicated: it needs to take the name of a function and a list of arguments and determine the correct .NET overload to call. (Even though I'm trying to keep this compiler simple, we need overload resolution in order to call <code>Console.WriteLine</code> -- we can't write hello world without it.)</p>
<p id="p14">First, have we ourselves defined a function with the right name?</p>

<div class="pygments_murphy"><pre><span class="ow">and</span> <span class="n">lambdaIdent</span> <span class="n">args</span> <span class="n">env</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">envMatches</span> <span class="o">=</span> 
        <span class="n">maybe</span> <span class="o">{</span>
            <span class="k">let</span><span class="o">!</span> <span class="n">v</span> <span class="o">=</span> <span class="nn">Map</span><span class="p">.</span><span class="n">tryFind</span> <span class="n">a</span> <span class="n">env</span>
            <span class="k">let</span><span class="o">!</span> <span class="n">r</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">v</span> <span class="k">with</span>
                <span class="o">|</span> <span class="nc">LambdaRef</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="n">v</span>
                <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">None</span>
            <span class="n">return</span> <span class="n">r</span>
        <span class="o">}</span> <span class="o">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">to_list</span>
</pre></div>



<p id="p15">Note: the <code>maybe</code> keyword isn't built into F#; we're using the F# equivalent of Haskell's Maybe monad, which <a href="http://en.wikibooks.org/wiki/F_Sharp_Programming/Computation_Expressions">a few</a> <a href="http://tomasp.net/articles/fsharp-iv-lang.aspx">other</a> <a href="http://codebetter.com/blogs/matthew.podwysocki/archive/2008/10/13/functional-c-linq-as-a-monad.aspx">people</a> have written about. Its purpose is to execute statements until one of them returns <code>None</code>; the result of the <code>maybe</code> block is determined by the <code>return r</code> at the bottom.</p>
<p id="p16">At this point, <code>envMatches</code> is a list of one or no <code>LambdaRef</code> nodes, taken from our environment. Next: attempting to parse the method name as <code>Namespace.Class.Method</code>. Again, note the use of <code>maybe</code> to simplify the code that deals with <code>Option</code> variables:</p>

<div class="pygments_murphy"><pre>    <span class="k">let</span> <span class="n">clrTypeAndMethodName</span> <span class="o">=</span> 
        <span class="n">maybe</span> <span class="o">{</span>
            <span class="k">let</span><span class="o">!</span> <span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">methodName</span><span class="o">)</span> <span class="o">=</span> 
                <span class="k">match</span> <span class="n">a</span><span class="o">.</span><span class="nc">LastIndexOf</span><span class="o">(</span><span class="sc">'.'</span><span class="o">)</span> <span class="k">with</span>
                <span class="o">|</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-&gt;</span> <span class="nc">None</span>
                <span class="o">|</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="nc">Substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">n</span><span class="o">),</span> <span class="n">a</span><span class="o">.</span><span class="nc">Substring</span><span class="o">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span>

            <span class="k">let</span><span class="o">!</span> <span class="n">clrType</span> <span class="o">=</span>
                <span class="n">referencedAssemblies</span>
                <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">assembly</span> <span class="o">-&gt;</span> 
                    <span class="n">usingNamespaces</span> 
                    <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">usingNamespace</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">assembly</span><span class="o">,</span> <span class="n">usingNamespace</span><span class="o">)))</span>
                <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">concat</span>
                <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">tryPick</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">assembly</span><span class="o">,</span> <span class="n">usingNamespace</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">option_of_nullable</span> <span class="o">&lt;|</span> <span class="n">assembly</span><span class="o">.</span><span class="nc">GetType</span><span class="o">(</span><span class="n">usingNamespace</span> <span class="o">+</span> <span class="s2">"."</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">))</span>

            <span class="n">return</span> <span class="o">(</span><span class="n">clrType</span><span class="o">,</span> <span class="n">methodName</span><span class="o">)</span>
        <span class="o">}</span> 
</pre></div>



<p id="p17"><code>referencedAssemblies</code> and <code>usingNamespaces</code> are hard-coded equivalents to C#'s assembly references and <code>using</code> statements. Next: a list of all the .NET methods with the right name, albeit maybe without the right parameter list:</p>

<div class="pygments_murphy"><pre>    <span class="k">let</span> <span class="n">clrMatches</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">clrTypeAndMethodName</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">clrType</span><span class="o">,</span> <span class="n">methodName</span><span class="o">)</span> <span class="o">-&gt;</span> 
            <span class="n">clrType</span><span class="o">.</span><span class="nc">GetMethods</span><span class="o">(</span><span class="nn">BindingFlags</span><span class="p">.</span><span class="nc">Public</span> <span class="o">|||</span> <span class="nn">BindingFlags</span><span class="p">.</span><span class="nc">Static</span><span class="o">)</span> 
            <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">of_array</span>
            <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="nc">Name</span> <span class="o">=</span> <span class="n">methodName</span><span class="o">)</span>
            <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">makeLambdaRef</span>

        <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> 
            <span class="o">[</span> <span class="o">]</span>
</pre></div>



<p id="p18">A function that determines whether a function's parameter list of compatible with a set of arguments. The <code>isParamArray</code> parameter indicates whether the .NET method has a variable parameter list (such as C#: <code>void WriteLine(string format, params object[] args)</code>).</p>

<div class="pygments_murphy"><pre>    <span class="k">let</span> <span class="n">argsMatchParameters</span> <span class="o">=</span> <span class="k">function</span>
        <span class="o">|</span> <span class="nc">LambdaRef</span> <span class="o">(_,</span> <span class="n">isParamArray</span><span class="o">,</span> <span class="n">parameterTypes</span><span class="o">)</span> <span class="o">-&gt;</span>
            <span class="k">let</span> <span class="k">rec</span> <span class="n">argsMatchParameters'</span> <span class="n">argTypes</span> <span class="o">(</span><span class="n">parameterTypes</span> <span class="o">:</span> <span class="o">#</span><span class="nc">Type</span> <span class="kt">list</span><span class="o">)</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">argTypes</span><span class="o">,</span> <span class="n">parameterTypes</span> <span class="k">with</span>
                <span class="o">|</span> <span class="o">[</span> <span class="o">],</span> <span class="o">[</span> <span class="o">]</span> <span class="o">-&gt;</span> 
                    <span class="o">//</span> <span class="nc">No</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">no</span> <span class="n">parameters</span> <span class="o">-&gt;</span> <span class="n">always</span> <span class="nc">OK</span>
                    <span class="bp">true</span>

                <span class="o">|</span> <span class="o">[</span> <span class="o">],</span> <span class="o">[</span> <span class="o">_</span> <span class="o">]</span> <span class="o">-&gt;</span> 
                    <span class="o">//</span> <span class="nc">No</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">one</span> <span class="n">parameter</span> <span class="o">-&gt;</span> <span class="nc">OK</span> <span class="n">only</span> <span class="k">for</span> <span class="n">params</span> <span class="kt">array</span> <span class="n">methods</span>
                    <span class="n">isParamArray</span>

                <span class="o">|</span> <span class="o">[</span> <span class="o">],</span> <span class="o">_</span> <span class="o">-&gt;</span>
                    <span class="o">//</span> <span class="nc">No</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">two</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">parameters</span> <span class="o">-&gt;</span> <span class="n">never</span> <span class="nc">OK</span>
                    <span class="bp">false</span>

                <span class="o">|</span> <span class="n">argType</span> <span class="o">::</span> <span class="n">otherArgTypes</span><span class="o">,</span> <span class="o">[</span> <span class="n">parameterType</span> <span class="o">]</span> <span class="k">when</span> <span class="n">isParamArray</span> <span class="o">-&gt;</span> 
                    <span class="o">//</span> <span class="nc">One</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">one</span> <span class="n">parameter</span><span class="o">,</span> <span class="k">in</span> <span class="n">a</span> <span class="n">params</span> <span class="kt">array</span> <span class="k">method</span> <span class="o">-&gt;</span>
                    <span class="o">//</span>  <span class="nc">OK</span> <span class="k">if</span> <span class="n">the</span> <span class="n">types</span> <span class="k">of</span> <span class="n">the</span> <span class="n">first</span> <span class="n">arg</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">params</span> <span class="kt">array</span> <span class="n">are</span> <span class="n">compatible</span><span class="o">,</span>
                    <span class="o">//</span>  <span class="ow">and</span> <span class="n">the</span> <span class="n">rest</span> <span class="k">of</span> <span class="n">the</span> <span class="n">args</span> <span class="k">match</span> <span class="n">the</span> <span class="n">params</span> <span class="kt">array</span>
                    <span class="n">parameterType</span><span class="o">.</span><span class="nc">GetElementType</span><span class="bp">()</span><span class="o">.</span><span class="nc">IsAssignableFrom</span><span class="o">(</span><span class="n">argType</span><span class="o">)</span> 
                    <span class="o">&amp;&amp;</span> <span class="n">argsMatchParameters'</span> <span class="n">otherArgTypes</span> <span class="n">parameterTypes</span>

                <span class="o">|</span> <span class="n">argType</span> <span class="o">::</span> <span class="n">otherArgTypes</span><span class="o">,</span> <span class="n">parameterType</span> <span class="o">::</span> <span class="n">otherParameterTypes</span> <span class="o">-&gt;</span> 
                    <span class="o">//</span> <span class="nc">One</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">one</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">parameters</span> <span class="o">-&gt;</span> 
                    <span class="o">//</span>  <span class="nc">OK</span> <span class="k">if</span> <span class="n">the</span> <span class="n">types</span> <span class="k">of</span> <span class="n">the</span> <span class="n">first</span> <span class="n">arg</span> <span class="ow">and</span> <span class="n">parameter</span> <span class="n">are</span> <span class="n">compatible</span><span class="o">,</span> 
                    <span class="o">//</span>  <span class="ow">and</span> <span class="n">the</span> <span class="n">rest</span> <span class="k">of</span> <span class="n">the</span> <span class="n">args</span> <span class="k">match</span> <span class="n">the</span> <span class="n">rest</span> <span class="k">of</span> <span class="n">the</span> <span class="n">parameters</span>
                    <span class="n">parameterType</span><span class="o">.</span><span class="nc">IsAssignableFrom</span><span class="o">(</span><span class="n">argType</span><span class="o">)</span> 
                    <span class="o">&amp;&amp;</span> <span class="n">argsMatchParameters'</span> <span class="n">otherArgTypes</span> <span class="n">otherParameterTypes</span>

                <span class="o">|</span> <span class="o">_</span> <span class="o">::</span> <span class="o">_,</span> <span class="o">[</span> <span class="o">]</span> <span class="o">-&gt;</span> 
                    <span class="o">//</span> <span class="nc">One</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">no</span> <span class="n">parameters</span> <span class="o">-&gt;</span> <span class="n">never</span> <span class="nc">OK</span>
                    <span class="bp">false</span>

            <span class="n">argsMatchParameters'</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">typeOf</span> <span class="n">env</span><span class="o">)</span> <span class="n">args</span><span class="o">)</span> <span class="n">parameterTypes</span>

        <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
</pre></div>



<p id="p19">Finally, a combined list of all candidates (both from the environment and from .NET), the method overloads whose parameters are compatible with our arguments, and the chosen overload itself. When given more than one compatible overload we pick the first one we've given. (The ECMA C# spec defines detailed rules for picking the most appropriate method overload, but we've ignoring those in our language.)</p>

<div class="pygments_murphy"><pre>    <span class="k">let</span> <span class="n">candidates</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">append</span> <span class="n">envMatches</span> <span class="n">clrMatches</span>
    <span class="k">match</span> <span class="n">candidates</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">[</span> <span class="o">]</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="o">&lt;|</span> <span class="nc">Compiler</span><span class="o">(</span><span class="n">sprintf</span> <span class="s2">"no method called %s"</span> <span class="n">a</span><span class="o">)</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>

    <span class="k">let</span> <span class="n">allMatches</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="n">argsMatchParameters</span> <span class="n">candidates</span>
    <span class="k">match</span> <span class="n">allMatches</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">[</span> <span class="o">]</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="o">&lt;|</span> <span class="nc">Compiler</span><span class="o">(</span><span class="n">sprintf</span> <span class="s2">"no overload of %s is compatible with %A"</span> <span class="n">a</span> <span class="n">args</span><span class="o">)</span>
    <span class="o">|</span> <span class="n">firstMatch</span> <span class="o">::</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">firstMatch</span>
</pre></div>



<p id="p20">We're now able to take a method name (as a <code>string</code>) and a list of arguments (as <code>LispVal</code> nodes), and decide what to call, whether it's one of our own functions or a method in a .NET library. We've done a large chunk of the work ahead of the next post, in which we'll finally get round to generating some useful IL.</p>



  </span>
</div>



  <div class="after_post"><a href="http://www.partario.com/blog/2009/06/lisp-compiler-in-f-expression-trees-and-net-methods.html#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
 <a href="../1">« Previous Page</a>

        </div><!-- End Prose Block -->
        
  <div class="right_sidebar">
    <div id="right_sidebar">
  <div id="links">
  <h3>About Tim</h3>
  <ul>
      <li><img src="/site_img/icon-github.png" width="16" height="16" alt="Github" valign="middle"/> Github - <a href="https://github.com/timrobinson/">timrobinson</a></li> 
      <li><img src="/site_img/icon-twitter.png" width="16" height="16" alt="Twitter" valign="middle"/> Twitter - <a href="http://twitter.com/1tgr">@1tgr</a></li> 
  </ul>
  </div>
  <div id="blog_post_list">
  <h3>Latest blog posts</h3>
  <ul>
    <li><a href="_posts/030.new_npackage_binaries.markdown">New NPackage binaries</a></li>
    <li><a href="_posts/029.this_week_on_npackage.markdown">This week on NPackage</a></li>
    <li><a href="_posts/028.first.markdown">First six NPackage packages</a></li>
    <li><a href="_posts/027.npackage_news.markdown">NPackage news</a></li>
    <li><a href="_posts/026.net_package_manager_feedback.markdown">.NET package manager feedback</a></li>
  </ul>
  </div>
  <div id="categories">
    <h3>Categories</h3>
    <ul>
     <li><a href="/blog/category/uncategorized">Uncategorized</a> (<a href="/blog/category/uncategorized/feed">rss</a>) (17)</li>
     <li><a href="/blog/category/npackage">NPackage</a> (<a href="/blog/category/npackage/feed">rss</a>) (6)</li>
     <li><a href="/blog/category/compiler">Compiler</a> (<a href="/blog/category/compiler/feed">rss</a>) (7)</li>
    </ul>
  </div> 
  <div id="archives">			
    <h3>Archives</h3>
    <ul>
      <li><a href="/blog/archive/2010/05/1" title="May 2010">May 2010</a>&nbsp;(3)</li>
      <li><a href="/blog/archive/2010/04/1" title="April 2010">April 2010</a>&nbsp;(5)</li>
      <li><a href="/blog/archive/2010/03/1" title="March 2010">March 2010</a>&nbsp;(1)</li>
      <li><a href="/blog/archive/2009/11/1" title="November 2009">November 2009</a>&nbsp;(1)</li>
      <li><a href="/blog/archive/2009/10/1" title="October 2009">October 2009</a>&nbsp;(1)</li>
      <li><a href="/blog/archive/2009/08/1" title="August 2009">August 2009</a>&nbsp;(1)</li>
      <li><a href="/blog/archive/2009/07/1" title="July 2009">July 2009</a>&nbsp;(3)</li>
      <li><a href="/blog/archive/2009/06/1" title="June 2009">June 2009</a>&nbsp;(6)</li>
      <li><a href="/blog/archive/2009/05/1" title="May 2009">May 2009</a>&nbsp;(3)</li>
      <li><a href="/blog/archive/2009/04/1" title="April 2009">April 2009</a>&nbsp;(6)</li>
    </ul>
  </div>

</div>

  </div>

      </div><!-- End Main Block -->
      <div id="footer">
        
  <p id="credits">
Powered by <a href="http://www.blogofile.com">Blogofile</a>.<br/>
<br/>
RSS feeds for <a href="http://feeds2.feedburner.com/TimRobinson">Entries</a>
 and <a
href="http://timrobinson.disqus.com/latest.rss">Comments</a>.
<br>
</p>
<script type="text/javascript">
//<![CDATA[
(function() {
		var links = document.getElementsByTagName('a');
		var query = '?';
		for(var i = 0; i < links.length; i++) {
			if(links[i].href.indexOf('#disqus_thread') >= 0) {
				query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
			}
		}
		document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/timrobinson/get_num_replies.js' + query + '"></' + 'script>');
	})();
//]]>
</script>


      </div> <!-- End Footer -->
    </div> <!-- End Content -->
  </body>
</html>





